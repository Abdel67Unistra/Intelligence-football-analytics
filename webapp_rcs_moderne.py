"""
üîµ‚ö™ Racing Club de Strasbourg - Interface Web Moderne
====================================================

Interface Streamlit compl√®te et moderne pour la plateforme d'analytics RCS
avec graphiques interactifs, analyses en temps r√©el et rapports automatis√©s.

Auteur: GitHub Copilot
Date: Septembre 2025
"""

import streamlit as st
import pandas as pd
import numpy as np
import plotly.express as px
import plotly.graph_objects as go
from plotly.subplots import make_subplots
import plotly.figure_factory as ff
from datetime import datetime, timedelta
import json
import time

# Import des modules RCS
try:
    from assets_rcs import AssetsRCS, assets_rcs
    from config_rcs import ConfigRCS, config_rcs
    from analytics_avances_rcs import AnalyticsAvancesRCS
except ImportError as e:
    st.error(f"Erreur d'import des modules RCS: {e}")
    st.stop()

# Configuration de la page
st.set_page_config(
    page_title="üîµ‚ö™ Racing Club de Strasbourg - Analytics Platform",
    page_icon="üîµ",
    layout="wide",
    initial_sidebar_state="expanded"
)

# Import des modules
try:
    from config_rcs import config_rcs, metriques, ui_config
    from analytics_avances_rcs import AnalyticsAvancesRCS
    from python_analytics.modules.collecteur_donnees_rcs import CollecteurDonneesRCS
    from python_analytics.modules.analyseur_rcs import AnalyseurPerformanceRCS
except ImportError:
    st.error("‚ùå Erreur d'import des modules. V√©rifiez l'installation.")
    st.stop()

# CSS personnalis√© avec logos RCS int√©gr√©s
st.markdown(assets_rcs.STREAMLIT_CSS, unsafe_allow_html=True)

# Header principal avec logos RCS
st.markdown(
    assets_rcs.get_header_rcs(
        "Racing Club de Strasbourg", 
        "Analytics Platform - Saison 2024-2025"
    ), 
    unsafe_allow_html=True
)

# CSS compl√©mentaire pour l'interface
st.markdown("""
<style>
    /* Boutons */
    .stButton > button {
        background-color: #0066CC;
        color: white;
        border-radius: 20px;
        border: none;
        padding: 0.5rem 2rem;
        font-weight: bold;
        transition: all 0.3s;
    }
    
    .stButton > button:hover {
        background-color: #004499;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 102, 204, 0.3);
    }
    
    /* Tabs */
    .stTabs [data-baseweb="tab-list"] {
        gap: 8px;
    }
    
    .stTabs [data-baseweb="tab"] {
        height: 50px;
        background-color: #f0f8ff;
        border-radius: 4px;
        color: #0066CC;
        font-weight: bold;
    }
    
    .stTabs [aria-selected="true"] {
        background-color: #0066CC;
        color: white;
    }
    
    /* Alertes */
    .alert-success {
        background-color: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
    }
    
    .alert-warning {
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
    }
    
    .alert-danger {
        background-color: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
        padding: 1rem;
        border-radius: 5px;
        margin: 1rem 0;
    }
</style>
""", unsafe_allow_html=True)

# Initialisation des donn√©es en cache
@st.cache_data(ttl=300)  # Cache de 5 minutes
def charger_donnees_rcs():
    """Charge les donn√©es RCS avec mise en cache"""
    try:
        collecteur = CollecteurDonneesRCS()
        analytics = AnalyticsAvancesRCS()
        
        # Chargement des donn√©es
        effectif = collecteur.recuperer_stats_joueurs_rcs()
        classement = collecteur.recuperer_classement_ligue1()
        
        # Chargement des analytics avanc√©s
        analytics.charger_donnees_completes()
        
        return {
            'effectif': effectif,
            'classement': classement,
            'analytics': analytics,
            'derniere_maj': datetime.now()
        }
    except Exception as e:
        st.error(f"‚ùå Erreur lors du chargement des donn√©es: {str(e)}")
        return None

def afficher_header():
    """Affiche le header principal de l'application"""
    st.markdown("""
    <div class="main-header">
        <h1>üîµ‚ö™ Racing Club de Strasbourg</h1>
        <h2>Plateforme d'Analytics Football Professionnelle</h2>
        <p>Saison 2024-2025 ‚Ä¢ Stade de la Meinau ‚Ä¢ Ligue 1</p>
    </div>
    """, unsafe_allow_html=True)

def afficher_sidebar(donnees):
    """Affiche la sidebar avec les contr√¥les"""
    st.sidebar.markdown("## üéõÔ∏è Contr√¥les")
    
    # S√©lection de la vue
    vue_selectionnee = st.sidebar.selectbox(
        "üéØ S√©lectionnez la vue",
        ["üè† Vue d'ensemble", "üë• Effectif d√©taill√©", "üìä Analytics avanc√©s", 
         "ü§ñ Pr√©dictions IA", "üè• Sant√© & Performance", "üìà Rapports"]
    )
    
    # Filtres
    st.sidebar.markdown("### üîç Filtres")
    
    postes_disponibles = ["Tous"] + list(donnees['effectif']['poste'].unique())
    postes_selectionnes = st.sidebar.multiselect(
        "Postes", postes_disponibles, default=["Tous"]
    )
    
    age_min, age_max = st.sidebar.slider(
        "Tranche d'√¢ge", 
        min_value=int(donnees['effectif']['age'].min()),
        max_value=int(donnees['effectif']['age'].max()),
        value=(int(donnees['effectif']['age'].min()), int(donnees['effectif']['age'].max()))
    )
    
    # Mise √† jour des donn√©es
    if st.sidebar.button("üîÑ Actualiser les donn√©es"):
        st.cache_data.clear()
        st.experimental_rerun()
    
    # Informations syst√®me
    st.sidebar.markdown("### ‚ÑπÔ∏è Informations")
    st.sidebar.info(f"**Derni√®re MAJ:** {donnees['derniere_maj'].strftime('%H:%M:%S')}")
    st.sidebar.info(f"**Joueurs:** {len(donnees['effectif'])}")
    st.sidebar.info(f"**Position Ligue 1:** {obtenir_position_rcs(donnees['classement'])}√®me")
    
    return vue_selectionnee, postes_selectionnes, (age_min, age_max)

def obtenir_position_rcs(classement_df):
    """R√©cup√®re la position actuelle du RCS"""
    try:
        rcs_row = classement_df[classement_df['equipe'] == 'Racing Club de Strasbourg']
        if not rcs_row.empty:
            return rcs_row.iloc[0]['position']
        return "N/A"
    except:
        return "N/A"

def afficher_vue_ensemble(donnees):
    """Affiche la vue d'ensemble du RCS"""
    st.markdown("## üè† Vue d'ensemble Racing Club de Strasbourg")
    
    # M√©triques principales
    col1, col2, col3, col4 = st.columns(4)
    
    with col1:
        position = obtenir_position_rcs(donnees['classement'])
        st.metric(
            label="üèÜ Position Ligue 1",
            value=f"{position}√®me",
            delta="Maintien confortable" if position != "N/A" and int(position) <= 15 else "Vigilance"
        )
    
    with col2:
        effectif_size = len(donnees['effectif'])
        valeur_totale = donnees['effectif']['valeur_marche'].sum()
        st.metric(
            label="üí∞ Valeur effectif",
            value=f"{valeur_totale:.1f}M‚Ç¨",
            delta=f"{effectif_size} joueurs"
        )
    
    with col3:
        note_moyenne = donnees['effectif']['note_moyenne'].mean()
        st.metric(
            label="‚≠ê Note moyenne",
            value=f"{note_moyenne:.2f}/10",
            delta="√âquipe" if note_moyenne >= 6.5 else "√Ä am√©liorer"
        )
    
    with col4:
        age_moyen = donnees['effectif']['age'].mean()
        st.metric(
            label="üë• √Çge moyen",
            value=f"{age_moyen:.1f} ans",
            delta="Exp√©rience" if age_moyen >= 25 else "Jeunesse"
        )
    
    # Graphiques principaux
    col1, col2 = st.columns(2)
    
    with col1:
        # R√©partition par poste
        fig_postes = px.pie(
            donnees['effectif'].groupby('poste').size().reset_index(),
            values=0, names='poste',
            title="üéØ R√©partition de l'effectif par poste",
            color_discrete_sequence=px.colors.qualitative.Set3
        )
        fig_postes.update_layout(height=400)
        st.plotly_chart(fig_postes, use_container_width=True)
    
    with col2:
        # Valeur vs Performance
        fig_valeur = px.scatter(
            donnees['effectif'], 
            x='note_moyenne', y='valeur_marche',
            size='age', color='poste',
            hover_name='nom',
            title="üíé Valeur marchande vs Performance",
            labels={'note_moyenne': 'Note moyenne', 'valeur_marche': 'Valeur (M‚Ç¨)'}
        )
        fig_valeur.update_layout(height=400)
        st.plotly_chart(fig_valeur, use_container_width=True)
    
    # Tableau des derni√®res performances
    st.markdown("### üìà Top 10 des performances actuelles")
    top_performers = donnees['effectif'].nlargest(10, 'note_moyenne')[
        ['nom', 'poste', 'age', 'note_moyenne', 'valeur_marche', 'matchs_joues']
    ]
    
    # Formatage du tableau
    top_performers_display = top_performers.copy()
    top_performers_display['note_moyenne'] = top_performers_display['note_moyenne'].round(2)
    top_performers_display['valeur_marche'] = top_performers_display['valeur_marche'].apply(lambda x: f"{x:.1f}M‚Ç¨")
    
    st.dataframe(
        top_performers_display,
        column_config={
            "nom": "Joueur",
            "poste": "Poste", 
            "age": "√Çge",
            "note_moyenne": "Note",
            "valeur_marche": "Valeur",
            "matchs_joues": "Matchs"
        },
        use_container_width=True
    )

def afficher_effectif_detaille(donnees, filtres):
    """Affiche l'effectif d√©taill√© avec filtres"""
    st.markdown("## üë• Effectif d√©taill√© - Saison 2024-2025")
    
    postes_filtres, (age_min, age_max) = filtres
    
    # Application des filtres
    effectif_filtre = donnees['effectif'].copy()
    
    if "Tous" not in postes_filtres:
        effectif_filtre = effectif_filtre[effectif_filtre['poste'].isin(postes_filtres)]
    
    effectif_filtre = effectif_filtre[
        (effectif_filtre['age'] >= age_min) & 
        (effectif_filtre['age'] <= age_max)
    ]
    
    # Statistiques filtr√©es
    col1, col2, col3 = st.columns(3)
    
    with col1:
        st.metric("Joueurs s√©lectionn√©s", len(effectif_filtre))
    with col2:
        st.metric("Valeur totale", f"{effectif_filtre['valeur_marche'].sum():.1f}M‚Ç¨")
    with col3:
        st.metric("Note moyenne", f"{effectif_filtre['note_moyenne'].mean():.2f}")
    
    # Graphiques de l'effectif
    col1, col2 = st.columns(2)
    
    with col1:
        # Distribution des √¢ges
        fig_age = px.histogram(
            effectif_filtre, x='age', 
            title="üìÖ Distribution des √¢ges",
            color_discrete_sequence=[config_rcs.couleur_primaire]
        )
        st.plotly_chart(fig_age, use_container_width=True)
    
    with col2:
        # Boxplot notes par poste
        fig_notes = px.box(
            effectif_filtre, x='poste', y='note_moyenne',
            title="üìä Distribution des notes par poste"
        )
        st.plotly_chart(fig_notes, use_container_width=True)
    
    # Tableau d√©taill√©
    st.markdown("### üìã Tableau d√©taill√© de l'effectif")
    
    # Ajout de colonnes calcul√©es
    effectif_display = effectif_filtre.copy()
    effectif_display['efficacite'] = (effectif_display['note_moyenne'] / 10 * 100).round(1)
    effectif_display['rapport_qualite_prix'] = (
        effectif_display['note_moyenne'] / effectif_display['valeur_marche']
    ).round(2)
    
    st.dataframe(
        effectif_display,
        column_config={
            "nom": "Joueur",
            "poste": "Poste",
            "age": "√Çge", 
            "note_moyenne": st.column_config.NumberColumn("Note", format="%.2f"),
            "valeur_marche": st.column_config.NumberColumn("Valeur (M‚Ç¨)", format="%.1f"),
            "matchs_joues": "Matchs",
            "efficacite": st.column_config.ProgressColumn("Efficacit√© (%)", min_value=0, max_value=100),
            "rapport_qualite_prix": "Qualit√©/Prix"
        },
        use_container_width=True
    )

def afficher_analytics_avances(donnees):
    """Affiche les analytics avanc√©s"""
    st.markdown("## üìä Analytics Avanc√©s - Intelligence Football")
    
    try:
        # G√©n√©ration du dashboard de performance
        dashboard = donnees['analytics'].creer_dashboard_performance()
        st.plotly_chart(dashboard, use_container_width=True)
        
        # M√©triques avanc√©es RCS
        st.markdown("### üéØ M√©triques Exclusives RCS")
        
        col1, col2, col3 = st.columns(3)
        
        with col1:
            # xG moyen √©quipe (simul√©)
            xg_moyen = 1.47
            st.metric(
                "‚öΩ xG moyen par match",
                f"{xg_moyen:.2f}",
                delta="Style contre-attaque"
            )
        
        with col2:
            # PPDA (simul√©) 
            ppda = 12.8
            st.metric(
                "üî• PPDA (Pressing)",
                f"{ppda:.1f}",
                delta="Intensit√© moyenne-haute"
            )
        
        with col3:
            # Probabilit√© maintien (simul√©)
            prob_maintien = 87.3
            st.metric(
                "üìà Probabilit√© maintien",
                f"{prob_maintien:.1f}%",
                delta="Objectif en bonne voie"
            )
        
        # Analyse de forme par joueur
        st.markdown("### üìà Analyse de forme individuelle")
        
        # S√©lection de joueur pour analyse d√©taill√©e
        joueur_selectionne = st.selectbox(
            "S√©lectionnez un joueur pour analyse d√©taill√©e",
            donnees['effectif']['nom'].tolist()
        )
        
        if joueur_selectionne:
            # Simulation d'analyse de forme
            analyse_forme = donnees['analytics'].analyseur.analyser_forme_joueur_rcs(
                joueur_selectionne, 10
            )
            
            if 'erreur' not in analyse_forme:
                col1, col2 = st.columns(2)
                
                with col1:
                    # M√©triques du joueur
                    st.markdown(f"**Analyse de {joueur_selectionne}**")
                    
                    joueur_info = donnees['effectif'][
                        donnees['effectif']['nom'] == joueur_selectionne
                    ].iloc[0]
                    
                    st.metric("Note moyenne saison", f"{joueur_info['note_moyenne']:.2f}")
                    st.metric("Matchs jou√©s", joueur_info['matchs_joues'])
                    st.metric("Valeur marchande", f"{joueur_info['valeur_marche']:.1f}M‚Ç¨")
                
                with col2:
                    # Graphique de forme (simul√©)
                    dates = pd.date_range(
                        start=datetime.now() - timedelta(days=100),
                        periods=10, freq='10D'
                    )
                    notes_simulees = np.random.normal(
                        joueur_info['note_moyenne'], 0.5, 10
                    )
                    notes_simulees = np.clip(notes_simulees, 4, 9)
                    
                    fig_forme = go.Figure()
                    fig_forme.add_trace(
                        go.Scatter(
                            x=dates, y=notes_simulees,
                            mode='lines+markers',
                            name=joueur_selectionne,
                            line=dict(color=config_rcs.couleur_primaire, width=3)
                        )
                    )
                    fig_forme.update_layout(
                        title=f"√âvolution de forme - {joueur_selectionne}",
                        xaxis_title="Date",
                        yaxis_title="Note",
                        height=300
                    )
                    st.plotly_chart(fig_forme, use_container_width=True)
        
    except Exception as e:
        st.error(f"‚ùå Erreur lors de la g√©n√©ration des analytics: {str(e)}")
        st.info("üìù Certaines fonctionnalit√©s n√©cessitent des donn√©es compl√®tes.")

def afficher_predictions_ia(donnees):
    """Affiche les pr√©dictions IA"""
    st.markdown("## ü§ñ Pr√©dictions Intelligence Artificielle")
    
    # Analyse des risques de blessures
    try:
        risques = donnees['analytics'].analyser_risques_blessures()
        
        st.markdown("### üè• Analyse des risques de blessures")
        
        # R√©sum√© des risques
        col1, col2, col3 = st.columns(3)
        
        risque_faible = len(risques[risques['niveau_risque'] == 'üü¢ Faible'])
        risque_moyen = len(risques[risques['niveau_risque'] == 'üü° Moyen'])
        risque_eleve = len(risques[risques['niveau_risque'] == 'üî¥ √âlev√©'])
        
        with col1:
            st.metric("üü¢ Risque faible", risque_faible)
        with col2:
            st.metric("üü° Risque moyen", risque_moyen)
        with col3:
            st.metric("üî¥ Risque √©lev√©", risque_eleve)
        
        # Tableau des risques
        st.dataframe(
            risques[['joueur', 'poste', 'age', 'niveau_risque', 'risque_blessure']],
            column_config={
                "joueur": "Joueur",
                "poste": "Poste",
                "age": "√Çge",
                "niveau_risque": "Niveau de risque",
                "risque_blessure": st.column_config.ProgressColumn(
                    "Score de risque", min_value=0, max_value=1
                )
            },
            use_container_width=True
        )
        
        # Recommandations IA
        st.markdown("### üéØ Recommandations IA")
        
        if risque_eleve > 0:
            st.markdown('<div class="alert-danger">‚ö†Ô∏è <strong>Attention:</strong> Joueurs √† risque √©lev√© d√©tect√©s. Repos pr√©ventif recommand√©.</div>', unsafe_allow_html=True)
        
        if risque_moyen > 3:
            st.markdown('<div class="alert-warning">‚ö†Ô∏è <strong>Vigilance:</strong> Plusieurs joueurs n√©cessitent une surveillance renforc√©e.</div>', unsafe_allow_html=True)
        
        if risque_faible >= len(donnees['effectif']) * 0.7:
            st.markdown('<div class="alert-success">‚úÖ <strong>Excellent:</strong> La majorit√© de l\'effectif pr√©sente un faible risque de blessure.</div>', unsafe_allow_html=True)
    
    except Exception as e:
        st.error(f"‚ùå Erreur lors de l'analyse des risques: {str(e)}")
    
    # Composition optimale IA
    st.markdown("### üéØ Composition optimale IA")
    
    try:
        composition = donnees['analytics'].optimiser_composition_ia()
        
        # Affichage de la composition
        formation_col1, formation_col2 = st.columns(2)
        
        with formation_col1:
            st.markdown("**Formation: 4-2-3-1**")
            
            for poste, joueurs in composition.items():
                if joueurs:  # Si des joueurs sont s√©lectionn√©s pour ce poste
                    st.markdown(f"**{poste}:**")
                    for joueur in joueurs:
                        score = joueur['score_selection']
                        st.write(f"  ‚Ä¢ {joueur['nom']} (Score: {score:.2f})")
        
        with formation_col2:
            # Visualisation tactique simplifi√©e
            fig_tactique = go.Figure()
            
            # Terrain
            fig_tactique.add_shape(
                type="rect", x0=0, y0=0, x1=10, y1=7,
                line=dict(color="green", width=2), fillcolor="lightgreen", opacity=0.3
            )
            
            # Positions approximatives en 4-2-3-1
            positions = {
                'GB': [(5, 0.5)],
                'DC': [(3, 2), (7, 2)],
                'DD': [(9, 2)], 'DG': [(1, 2)],
                'MDC': [(3.5, 4), (6.5, 4)],
                'MOC': [(5, 5.5)],
                'AD': [(8.5, 5.5)], 'AG': [(1.5, 5.5)],
                'BU': [(5, 6.5)]
            }
            
            for poste, coords in positions.items():
                for x, y in coords:
                    fig_tactique.add_trace(
                        go.Scatter(
                            x=[x], y=[y], mode='markers+text',
                            marker=dict(size=20, color=config_rcs.couleur_primaire),
                            text=[poste], textposition="middle center",
                            textfont=dict(color="white", size=10),
                            showlegend=False
                        )
                    )
            
            fig_tactique.update_layout(
                title="Formation 4-2-3-1 RCS",
                xaxis=dict(showgrid=False, showticklabels=False, range=[0, 10]),
                yaxis=dict(showgrid=False, showticklabels=False, range=[0, 7]),
                height=400
            )
            
            st.plotly_chart(fig_tactique, use_container_width=True)
    
    except Exception as e:
        st.error(f"‚ùå Erreur lors de l'optimisation de composition: {str(e)}")

def afficher_sante_performance(donnees):
    """Affiche les m√©triques de sant√© et performance"""
    st.markdown("## üè• Sant√© & Performance de l'effectif")
    
    # M√©triques de charge de travail
    st.markdown("### üìä Charge de travail")
    
    # Simulation de donn√©es de fatigue
    effectif_avec_fatigue = donnees['effectif'].copy()
    effectif_avec_fatigue['fatigue_estimee'] = np.random.uniform(0.2, 0.8, len(effectif_avec_fatigue))
    effectif_avec_fatigue['minutes_totales'] = effectif_avec_fatigue['matchs_joues'] * 75  # Estimation
    
    # Graphiques de charge
    col1, col2 = st.columns(2)
    
    with col1:
        fig_fatigue = px.bar(
            effectif_avec_fatigue.nlargest(10, 'fatigue_estimee'),
            x='fatigue_estimee', y='nom',
            orientation='h',
            title="üîã Niveau de fatigue estim√© (Top 10)",
            color='fatigue_estimee',
            color_continuous_scale=['green', 'yellow', 'red']
        )
        st.plotly_chart(fig_fatigue, use_container_width=True)
    
    with col2:
        fig_minutes = px.scatter(
            effectif_avec_fatigue,
            x='minutes_totales', y='fatigue_estimee',
            size='age', color='poste',
            hover_name='nom',
            title="‚è±Ô∏è Minutes jou√©es vs Fatigue"
        )
        st.plotly_chart(fig_minutes, use_container_width=True)
    
    # Alertes de sant√©
    st.markdown("### ‚ö†Ô∏è Alertes de sant√©")
    
    # D√©tection automatique d'alertes
    alertes = []
    
    for _, joueur in effectif_avec_fatigue.iterrows():
        if joueur['fatigue_estimee'] > 0.7:
            alertes.append({
                'type': 'danger',
                'joueur': joueur['nom'],
                'message': f"Fatigue √©lev√©e ({joueur['fatigue_estimee']:.1%}) - Repos recommand√©"
            })
        elif joueur['matchs_joues'] > 15 and joueur['age'] > 30:
            alertes.append({
                'type': 'warning',
                'joueur': joueur['nom'],
                'message': f"Charge importante ({joueur['matchs_joues']} matchs) pour un joueur exp√©riment√©"
            })
        elif joueur['note_moyenne'] < 6.0:
            alertes.append({
                'type': 'warning',
                'joueur': joueur['nom'],
                'message': f"Performance en baisse (note: {joueur['note_moyenne']:.2f})"
            })
    
    if alertes:
        for alerte in alertes:
            if alerte['type'] == 'danger':
                st.markdown(f'<div class="alert-danger">üö® <strong>{alerte["joueur"]}:</strong> {alerte["message"]}</div>', unsafe_allow_html=True)
            else:
                st.markdown(f'<div class="alert-warning">‚ö†Ô∏è <strong>{alerte["joueur"]}:</strong> {alerte["message"]}</div>', unsafe_allow_html=True)
    else:
        st.markdown('<div class="alert-success">‚úÖ Aucune alerte critique d√©tect√©e. L\'effectif est en bonne condition.</div>', unsafe_allow_html=True)

def afficher_rapports(donnees):
    """Affiche les rapports automatis√©s"""
    st.markdown("## üìà Rapports & Analyses Automatis√©es")
    
    # G√©n√©ration du rapport hebdomadaire
    try:
        rapport = donnees['analytics'].generer_rapport_weekly()
        
        st.markdown("### üìã Rapport Hebdomadaire Automatis√©")
        
        # Informations g√©n√©rales
        col1, col2 = st.columns(2)
        
        with col1:
            st.markdown(f"**Date de g√©n√©ration:** {rapport['date_generation']}")
            st.markdown(f"**Saison:** {rapport['saison']}")
            st.markdown(f"**Position Ligue 1:** {rapport['position_ligue1']}√®me")
            st.markdown(f"**Meilleur joueur:** {rapport['meilleur_joueur']} ({rapport['meilleure_note']:.2f})")
        
        with col2:
            st.markdown(f"**Note moyenne √©quipe:** {rapport['note_moyenne_equipe']:.2f}")
            st.markdown(f"**√Çge moyen:** {rapport['age_moyen']:.1f} ans")
            st.markdown(f"**Valeur totale effectif:** {rapport['valeur_totale']:.1f}M‚Ç¨")
        
        # Alertes automatiques
        if rapport['joueurs_fatigue']:
            st.markdown("#### ‚ö†Ô∏è Joueurs en situation de fatigue")
            for joueur in rapport['joueurs_fatigue']:
                st.warning(f"üîã **{joueur['nom']}** - {joueur['matchs_joues']} matchs jou√©s (fatigue: {joueur['fatigue_moyenne']:.1%})")
        
        if rapport['joueurs_forme_descendante']:
            st.markdown("#### üìâ Joueurs en baisse de forme")
            for joueur in rapport['joueurs_forme_descendante']:
                st.warning(f"üìà **{joueur['nom']}** - Baisse de {joueur['baisse']:.2f} pts (forme actuelle: {joueur['forme_actuelle']:.2f})")
        
        # Axes d'am√©lioration
        if rapport['axes_amelioration']:
            st.markdown("#### üéØ Axes d'am√©lioration prioritaires")
            for axe in rapport['axes_amelioration']:
                priorite_color = "üî¥" if axe['priorite'] == 'Haute' else "üü°"
                st.info(f"{priorite_color} **{axe['domaine']}** (Note: {axe['note_actuelle']:.2f}) - {axe['recommandation']}")
        
    except Exception as e:
        st.error(f"‚ùå Erreur lors de la g√©n√©ration du rapport: {str(e)}")
    
    # Boutons d'export
    st.markdown("### üì§ Export des donn√©es")
    
    col1, col2, col3 = st.columns(3)
    
    with col1:
        if st.button("üìä Exporter effectif (CSV)"):
            csv = donnees['effectif'].to_csv(index=False)
            st.download_button(
                label="üíæ T√©l√©charger CSV",
                data=csv,
                file_name=f"effectif_rcs_{datetime.now().strftime('%Y%m%d')}.csv",
                mime="text/csv"
            )
    
    with col2:
        if st.button("üìà Exporter graphiques"):
            st.info("üöß Fonctionnalit√© en d√©veloppement")
    
    with col3:
        if st.button("üìã Rapport PDF"):
            st.info("üöß G√©n√©ration PDF √† venir")

def main():
    """Fonction principale de l'application"""
    
    # Affichage du header
    afficher_header()
    
    # Chargement des donn√©es
    with st.spinner("‚è≥ Chargement des donn√©es RCS..."):
        donnees = charger_donnees_rcs()
    
    if donnees is None:
        st.error("‚ùå Impossible de charger les donn√©es. V√©rifiez la connexion.")
        st.stop()
    
    # Sidebar et filtres
    vue_selectionnee, postes_filtres, filtres_age = afficher_sidebar(donnees)
    filtres = (postes_filtres, filtres_age)
    
    # Affichage selon la vue s√©lectionn√©e
    if vue_selectionnee == "üè† Vue d'ensemble":
        afficher_vue_ensemble(donnees)
    
    elif vue_selectionnee == "üë• Effectif d√©taill√©":
        afficher_effectif_detaille(donnees, filtres)
    
    elif vue_selectionnee == "üìä Analytics avanc√©s":
        afficher_analytics_avances(donnees)
    
    elif vue_selectionnee == "ü§ñ Pr√©dictions IA":
        afficher_predictions_ia(donnees)
    
    elif vue_selectionnee == "üè• Sant√© & Performance":
        afficher_sante_performance(donnees)
    
    elif vue_selectionnee == "üìà Rapports":
        afficher_rapports(donnees)
    
    # Footer
    st.markdown("---")
    st.markdown(
        f"üîµ‚ö™ **Racing Club de Strasbourg Analytics Platform** | "
        f"Saison {config_rcs.saison} | "
        f"G√©n√©r√© le {datetime.now().strftime('%d/%m/%Y √† %H:%M:%S')}"
    )

if __name__ == "__main__":
    main()
